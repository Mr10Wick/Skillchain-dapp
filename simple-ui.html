<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>SkillChain Interface</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background: #f4f4f9; }
        .box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        input { padding: 8px; width: 70%; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        #status { margin-top: 10px; font-weight: bold; }
    </style>
    <!-- Import Ethers.js depuis un CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" type="application/javascript"></script>
    <script>
        window.addEventListener('load', () => {
            // V√©rification de l'environnement d'ex√©cution (Fichier local vs Serveur)
            if (window.location.protocol === 'file:' && !window.ethereum) {
                const warning = document.createElement('div');
                warning.style.cssText = "background: #fff3cd; color: #856404; padding: 15px; margin-bottom: 20px; border: 1px solid #ffeeba; border-radius: 5px;";
                warning.innerHTML = `
                    <strong>‚ö†Ô∏è Attention : Mode Fichier Local d√©tect√©</strong><br>
                    Pour utiliser MetaMask ici, allez dans <em>Extensions > MetaMask > D√©tails</em> et activez <strong>"Autoriser l'acc√®s aux URL de fichier"</strong>.<br>
                    Ensuite, rafra√Æchissez la page.
                `;
                document.body.insertBefore(warning, document.body.firstChild);
            }

            // Gestion des √©v√©nements MetaMask (Changement de compte/r√©seau)
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', () => window.location.reload());
                window.ethereum.on('chainChanged', () => window.location.reload());
            }
        });
    </script>
</head>
<body>
    <h1>SkillChain Dashboard üè†</h1>

    <div class="box">
        <h3>1. Connexion</h3>
        <button onclick="connectWallet()">Connecter MetaMask</button>
        <p>Compte: <span id="account">Non connect√©</span></p>
        <p>Solde ETH: <span id="ethBalance">-</span></p>
        <p style="font-size: 0.8em; color: gray;">Contrat cible : <span id="targetContract">...</span></p>
    </div>

    <div class="box">
        <h3>2. Cr√©er une Ressource (Mint)</h3>
        <input type="text" id="mintType" placeholder="Type (ex: Maison)">
        <input type="number" id="mintValue" placeholder="Valeur (ex: 100)">
        <button onclick="mintToken()">Mint Token</button>
    </div>

    <div class="box">
        <h3>3. Mon Portefeuille</h3>
        <p>Solde actuel : <span id="balance">0</span> / 4</p>
        <button onclick="loadMyTokens()">üîÑ Actualiser la liste</button>
        <div id="tokenList" style="margin-top: 15px;"></div>
    </div>

    <div id="status"></div>

    <script>
        // Configuration du contrat
        const CONTRACT_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3"; 
        
        document.getElementById("targetContract").innerText = CONTRACT_ADDRESS;

        // Interface binaire de l'application (ABI)
        const ABI = [
            "function safeMint(address to, string uri, string _type, uint256 _value)",
            "function balanceOf(address owner) view returns (uint256)",
            // Fonctions de lecture
            "function ownerOf(uint256 tokenId) view returns (address)",
            "function getResourceDetails(uint256 tokenId) view returns (tuple(string resourceType, uint256 value, uint256 createdAt))"
        ];

        let provider, signer, contract;

        async function connectWallet() {
            if (!window.ethereum) {
                // Gestion des restrictions de s√©curit√© locales
                if (window.location.protocol === 'file:') {
                    log("‚ùå Erreur: MetaMask bloqu√©. Activez 'Autoriser l'acc√®s aux URL de fichier' dans les extensions.");
                    return alert("Oups ! Sur un fichier local, vous devez autoriser MetaMask √† acc√©der aux URL de fichier (dans les r√©glages de l'extension).");
                }
                log("‚ùå Erreur: MetaMask introuvable. Veuillez installer l'extension.");
                return alert("MetaMask non d√©tect√© !\n\nSolutions :\n1. Rafra√Æchissez la page (F5)\n2. V√©rifiez que vous n'√™tes pas en Navigation Priv√©e\n3. Red√©marrez le navigateur");
            }
            
            try {
                log("‚è≥ Ouverture de MetaMask... (V√©rifiez l'ic√¥ne du renard en haut √† droite !)");
                // Demande l'acc√®s √† MetaMask
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Configuration du r√©seau
                await switchToLocalhost();
                
                if (typeof ethers === 'undefined') {
                    throw new Error("Ethers.js n'est pas charg√©. V√©rifiez votre connexion internet.");
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                const address = await signer.getAddress();
                
                document.getElementById("account").innerText = address;

                // R√©cup√©ration du solde ETH
                const ethBalance = await provider.getBalance(address);
                const ethStr = ethers.utils.formatEther(ethBalance);
                document.getElementById("ethBalance").innerText = ethStr + " ETH";

                if (ethStr === "0.0") {
                    document.getElementById("ethBalance").style.color = "red";
                    document.getElementById("ethBalance").innerHTML += " <br>‚ö†Ô∏è <strong>Mauvais compte !</strong> S√©lectionnez le compte avec 10000 ETH dans MetaMask.";
                }
                
                // Connexion au contrat
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

                // V√©rification du d√©ploiement du contrat
                const code = await provider.getCode(CONTRACT_ADDRESS);
                if (code === "0x") {
                    contract = null; // D√©sactivation des interactions
                    log("‚ùå Erreur: Contrat non d√©ploy√© ! (Voir alerte)");
                    alert("‚ö†Ô∏è ERREUR CRITIQUE ‚ö†Ô∏è\n\nLe contrat n'est pas d√©ploy√© √† cette adresse !\n\n1. V√©rifiez que 'npx hardhat node' tourne.\n2. Red√©ployez : 'npx hardhat run scripts/deploy.ts --network localhost'.\n3. Copiez la NOUVELLE adresse dans le fichier HTML.");
                    return;
                }

                log("‚úÖ Connect√© ! Pr√™t √† interagir.");
                loadMyTokens(); // Chargement initial
            } catch (err) {
                console.error(err);
                if (err.message && (err.message.includes("RPC endpoint") || err.message.includes("too many errors"))) {
                    log("‚ùå Erreur RPC: N≈ìud inaccessible. (Voir alerte)");
                    alert("‚ö†Ô∏è ERREUR DE CONNEXION RPC ‚ö†Ô∏è\n\nMetaMask n'arrive pas √† joindre votre Blockchain locale.\n\nSOLUTIONS :\n1. V√©rifiez que 'npx hardhat node' tourne.\n2. Dans MetaMask, changez de r√©seau (ex: Mainnet) puis revenez sur Localhost pour forcer la reconnexion.");
                } else {
                    log("‚ùå Erreur connexion: " + err.message);
                }
            }
        }

        async function mintToken() {
            if (!contract) return alert("Connecte-toi d'abord !");
            
            const type = document.getElementById("mintType").value;
            const val = document.getElementById("mintValue").value;
            const address = await signer.getAddress();

            try {
                log("‚è≥ Veuillez confirmer la transaction dans MetaMask...");
                // Ex√©cution de la transaction
                const tx = await contract.safeMint(address, "ipfs://demo", type, val);
                log("Transaction envoy√©e (" + tx.hash.substring(0, 10) + "...). Attente de validation...");
                await tx.wait(); // Confirmation
                log("‚úÖ Succ√®s ! Token cr√©√©.");
                loadMyTokens(); // Mise √† jour de l'interface
            } catch (err) {
                console.error(err);
                // Gestion des erreurs sp√©cifiques
                if (err.code === -32002 || (err.message && err.message.includes("-32002"))) {
                    log("‚ùå Erreur RPC: N≈ìud √©teint ou inaccessible.");
                    alert("‚ö†Ô∏è ERREUR DE CONNEXION (-32002) ‚ö†Ô∏è\n\nMetaMask n'arrive pas √† joindre votre Blockchain locale.\n\nCAUSE :\nVous avez probablement ferm√© le terminal 'npx hardhat node'.\n\nSOLUTION :\n1. Rouvrez un terminal et lancez 'npx hardhat node'.\n2. Dans un AUTRE terminal, red√©ployez : 'npx hardhat run scripts/deploy.ts --network localhost'.\n3. R√©initialisez le Nonce dans MetaMask.");
                } else if (err.message && (err.message.includes("nonce") || err.message.includes("Nonce"))) {
                    log("‚ùå Erreur Nonce: R√©initialisez MetaMask !");
                    alert("‚ö†Ô∏è ERREUR DE SYNCHRONISATION (Nonce) ‚ö†Ô∏è\n\nMetaMask est d√©synchronis√© car la blockchain a red√©marr√©.\n\nSOLUTION :\n1. Ouvrez MetaMask\n2. Allez dans Param√®tres > Avanc√©s\n3. Cliquez sur 'Effacer les donn√©es de l'onglet d'activit√©'\n4. R√©essayez.");
                } else if (err.reason) {
                    log("‚ùå Erreur: " + err.reason);
                } else {
                    log("‚ùå Erreur (voir console)");
                }
            }
        }

        // R√©cup√©ration des tokens de l'utilisateur
        // Note : It√©ration sur les IDs (Alternative √† ERC721Enumerable)
        async function loadMyTokens() {
            if (!contract) return;
            const address = await signer.getAddress();
            const listDiv = document.getElementById("tokenList");
            
            try {
                // R√©cup√©ration du solde
                const balance = await contract.balanceOf(address);
                console.log("Solde NFT:", balance.toString());
                document.getElementById("balance").innerText = balance.toString();

                // Scan des tokens (ID 0 √† 9)
                listDiv.innerHTML = "<i>Chargement...</i>";
                let html = "";
                
                for(let i = 0; i < 10; i++) {
                    try {
                        const owner = await contract.ownerOf(i);
                        // Normalisation des adresses pour comparaison
                        if (owner.toLowerCase() === address.toLowerCase()) {
                            const details = await contract.getResourceDetails(i);
                            html += `<div style="background:#eef; border-left: 4px solid #007bff; padding:10px; margin-bottom:5px;">
                                <strong>Token #${i}</strong> : ${details.resourceType} (Valeur: ${details.value})
                            </div>`;
                        }
                    } catch (e) {
                        // Arr√™t si le token n'existe pas
                        break;
                    }
                }
                listDiv.innerHTML = html || "Vous ne poss√©dez aucune ressource.";
            } catch (err) {
                console.error(err);
                listDiv.innerHTML = `<div style="color:red; background:#fff0f0; padding:10px; border-radius:5px;">‚ö†Ô∏è <strong>Erreur de connexion</strong><br>Impossible de charger vos tokens.<br>V√©rifiez que <code>npx hardhat node</code> tourne.</div>`;
            }
        }

        // Configuration automatique du r√©seau
        async function switchToLocalhost() {
            const chainId = "0x7a69"; // 31337 en hexad√©cimal (Hardhat Network)
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: chainId }],
                });
            } catch (error) {
                // Ajout du r√©seau si inexistant (Erreur 4902)
                if (error.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: chainId,
                            chainName: 'Hardhat Localhost',
                            rpcUrls: ['http://127.0.0.1:8545'],
                            nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 }
                        }],
                    });
                } else {
                    // Propagation des autres erreurs
                    throw error;
                }
            }
        }

        function log(msg) {
            document.getElementById("status").innerText = msg;
        }
    </script>
</body>
</html>